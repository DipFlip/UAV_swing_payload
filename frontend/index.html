<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone + Hanging Weight Simulation</title>
    <link rel="stylesheet" href="style.css?v=2.0">
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>

        <div id="hud">
            <div id="hud-header"><h3>Simulation HUD</h3><button id="hud-toggle">&#x25BC;</button></div>
            <div id="hud-content">
                <div id="hud-time">Time: 0.00 s</div>
                <div id="hud-drone">Drone: (0, 0, 0)</div>
                <div id="hud-weight">Weight: (0, 0, 0)</div>
                <div id="hud-angles">Angles: φx=0.00° φy=0.00°</div>
                <div id="hud-control">Control: Fx=0 Fy=0 Fz=0</div>
                <div id="hud-status">Status: Connecting...</div>
                <div id="hud-version" style="color:#666;font-size:11px">v2.0</div>
            </div>
        </div>

        <div id="chart-panel">
            <div id="chart-header"><span>Charts</span><button id="chart-toggle">&#x25BC;</button></div>
            <div id="chart-content"></div>
        </div>

        <div id="controls">
            <h3 class="collapsible" id="goal-header">Goal Position <span class="section-arrow">&#x25BC;</span></h3>
            <div id="goal-content" class="section-content">
                <div class="slider-group">
                    <label>X: <span id="x-val">0.0</span> m</label>
                    <input type="range" id="slider-x" min="-10" max="10" step="0.5" value="0">
                </div>
                <div class="slider-group">
                    <label>Y: <span id="y-val">0.0</span> m</label>
                    <input type="range" id="slider-y" min="-10" max="10" step="0.5" value="0">
                </div>
                <div class="slider-group">
                    <label>Z: <span id="z-val">1.0</span> m</label>
                    <input type="range" id="slider-z" min="0" max="15" step="0.5" value="1">
                </div>
                <div class="slider-group">
                    <label>Pattern spd: <span id="speed-val">1.0</span>x</label>
                    <input type="range" id="slider-speed" min="0.2" max="3.0" step="0.2" value="1.0">
                </div>
            </div>
            <h3 class="collapsible" id="sim-header">Simulation <span class="section-arrow">&#x25BC;</span></h3>
            <div id="sim-content" class="section-content">
                <div class="slider-group">
                    <label>Drone mass: <span id="md-val">2.0</span> kg</label>
                    <input type="range" id="slider-md" min="0.5" max="10" step="0.5" value="2.0">
                </div>
                <div class="slider-group">
                    <label>Payload: <span id="mw-val">5.0</span> kg</label>
                    <input type="range" id="slider-mw" min="0.5" max="20" step="0.5" value="5.0">
                </div>
                <div class="slider-group">
                    <label>Rope: <span id="rope-val">4.0</span> m</label>
                    <input type="range" id="slider-rope" min="1" max="10" step="0.5" value="4.0">
                </div>
                <div class="slider-group">
                    <label>Max force: <span id="fmax-val">80</span> N</label>
                    <input type="range" id="slider-fmax" min="5" max="200" step="5" value="80">
                </div>
                <div class="slider-group">
                    <label>Time scale: <span id="timescale-val">100</span>%</label>
                    <input type="range" id="slider-timescale" min="5" max="100" step="5" value="100">
                </div>
            </div>
            <h3 class="collapsible" id="algo-header">Algorithm <span class="section-arrow">&#x25B6;</span></h3>
            <div id="algo-content" class="section-content collapsed">
                <div class="drone-config">
                    <div class="algo-row">
                        <label>Drone A <span style="color:#4499ff">(blue)</span></label>
                        <select id="algo-a">
                            <option value="lqr" selected>LQR</option>
                            <option value="pid">PID</option>
                            <option value="cascade">Cascade PD</option>
                            <option value="flatness">Flatness FF</option>
                        </select>
                        <label class="cb-label" title="Energy-based swing damping: adds force proportional to pendulum angular velocity to dissipate swing energy. Can be layered on any algorithm."><input type="checkbox" id="swing-a"> Anti-swing</label>
                    </div>
                    <div id="params-a" class="algo-params"></div>
                </div>
                <div class="drone-config">
                    <div class="algo-row">
                        <label>Drone B <span style="color:#ff8800">(orange)</span></label>
                        <select id="algo-b">
                            <option value="lqr">LQR</option>
                            <option value="pid" selected>PID</option>
                            <option value="cascade">Cascade PD</option>
                            <option value="flatness">Flatness FF</option>
                        </select>
                        <label class="cb-label" title="Energy-based swing damping: adds force proportional to pendulum angular velocity to dissipate swing energy. Can be layered on any algorithm."><input type="checkbox" id="swing-b"> Anti-swing</label>
                    </div>
                    <div id="params-b" class="algo-params"></div>
                </div>
                <button id="btn-algo-info" class="info-btn" title="Algorithm info">i</button>
            </div>
            <div class="button-group">
                <button id="btn-pause">Pause</button>
                <button id="btn-pattern">Square</button>
                <button id="btn-reset">Reset</button>
            </div>
        </div>

        <div id="algo-info-panel">
            <div id="info-panel-header"><span>Algorithm Info</span><button id="info-panel-toggle">&#x25BC;</button></div>
            <div id="info-panel-content">
                <p><strong>LQR</strong> &mdash; Full-state feedback using all 10 state variables including pendulum angles. Solves the Riccati equation for optimal gains. Tunable: position weight (tracking speed), swing weight (pendulum suppression), control cost (force economy).</p>
                <p><strong>PID</strong> &mdash; Classic 3-axis position control, blind to pendulum dynamics. Uses derivative-on-measurement to avoid setpoint kick. Tunable: Kp (proportional response), Ki (steady-state error), Kd (damping).</p>
                <p><strong>Cascade PD</strong> &mdash; Two nested loops: outer tracks payload position, inner drives the drone. Naturally reduces swing by explicitly following the payload. Tunable: outer gains (payload tracking) and inner gains (drone response).</p>
                <p><strong>Flatness FF</strong> &mdash; Exploits differential flatness: algebraically inverts the dynamics to compute feedforward drone position and forces from a smooth payload reference trajectory. Tunable: reference speed (filter bandwidth), position and angle feedback gains.</p>
                <p><strong>Anti-swing</strong> &mdash; Energy-based damping layered on any algorithm. Adds force proportional to <code>&phi;&#x307;</code> to actively dissipate swing energy.</p>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module" src="main.js?v=2.0"></script>
</body>
</html>
