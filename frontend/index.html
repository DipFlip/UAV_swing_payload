<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone + Hanging Weight Simulation</title>
    <link rel="stylesheet" href="style.css?v=2.0">
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>

        <div id="hud">
            <div id="hud-header"><h3>Simulation HUD</h3><button id="hud-toggle">&#x25BC;</button></div>
            <div id="hud-content">
                <div id="hud-time">Time: 0.00 s</div>
                <div id="hud-drone">Drone: (0, 0, 0)</div>
                <div id="hud-weight">Weight: (0, 0, 0)</div>
                <div id="hud-angles">Angles: φx=0.00° φy=0.00°</div>
                <div id="hud-control">Control: Fx=0 Fy=0 Fz=0</div>
                <div id="hud-status">Status: Connecting...</div>
                <div id="hud-version" style="color:#666;font-size:11px">v2.3</div>
            </div>
        </div>

        <div id="chart-panel">
            <div id="chart-header"><span>Charts</span><button id="chart-toggle">&#x25BC;</button></div>
            <div id="chart-content"></div>
        </div>

        <div id="controls">
            <h3 class="collapsible" id="goal-header">Goal Position <span class="section-arrow">&#x25BC;</span></h3>
            <div id="goal-content" class="section-content">
                <div class="slider-group">
                    <label>X: <span id="x-val">0.0</span> m</label>
                    <input type="range" id="slider-x" min="-10" max="10" step="0.5" value="0">
                </div>
                <div class="slider-group">
                    <label>Y: <span id="y-val">0.0</span> m</label>
                    <input type="range" id="slider-y" min="-10" max="10" step="0.5" value="0">
                </div>
                <div class="slider-group">
                    <label>Z: <span id="z-val">1.0</span> m</label>
                    <input type="range" id="slider-z" min="0" max="15" step="0.5" value="1">
                </div>
                <div class="slider-group">
                    <label>Pattern spd: <span id="speed-val">1.0</span>x</label>
                    <input type="range" id="slider-speed" min="0.2" max="3.0" step="0.2" value="1.0">
                </div>
            </div>
            <h3 class="collapsible" id="sim-header">Simulation <span class="section-arrow">&#x25B6;</span></h3>
            <div id="sim-content" class="section-content collapsed">
                <div class="slider-group">
                    <label>Drone mass: <span id="md-val">2.0</span> kg</label>
                    <input type="range" id="slider-md" min="0.5" max="10" step="0.5" value="2.0">
                </div>
                <div class="slider-group">
                    <label>Payload: <span id="mw-val">5.0</span> kg</label>
                    <input type="range" id="slider-mw" min="0.5" max="20" step="0.5" value="5.0">
                </div>
                <div class="slider-group">
                    <label>Rope: <span id="rope-val">4.0</span> m</label>
                    <input type="range" id="slider-rope" min="1" max="10" step="0.5" value="4.0">
                </div>
                <div class="slider-group">
                    <label>Max force: <span id="fmax-val">80</span> N</label>
                    <input type="range" id="slider-fmax" min="5" max="200" step="5" value="80">
                </div>
                <div class="slider-group">
                    <label>Time scale: <span id="timescale-val">100</span>%</label>
                    <input type="range" id="slider-timescale" min="5" max="100" step="5" value="100">
                </div>
            </div>
            <h3 class="collapsible" id="algo-header">Algorithm <span class="section-arrow">&#x25BC;</span></h3>
            <div id="algo-content" class="section-content">
                <div class="drone-config">
                    <div class="algo-row">
                        <label>Drone A <span style="color:#4499ff">(blue)</span></label>
                        <select id="algo-a">
                            <option value="lqr" selected>LQR</option>
                            <option value="pid">PID</option>
                            <option value="cascade">Cascade PD</option>
                            <option value="flatness">Flatness FF</option>
                        </select>
                        <label class="cb-label" title="Energy-based swing damping: adds force proportional to pendulum angular velocity to dissipate swing energy. Can be layered on any algorithm."><input type="checkbox" id="swing-a"> Anti-swing</label>
                    </div>
                    <div id="params-a" class="algo-params"></div>
                    <button id="reset-a" class="reset-params-btn">Reset to default</button>
                </div>
                <div class="drone-config">
                    <div class="algo-row">
                        <label>Drone B <span style="color:#ff8800">(orange)</span></label>
                        <select id="algo-b">
                            <option value="lqr">LQR</option>
                            <option value="pid" selected>PID</option>
                            <option value="cascade">Cascade PD</option>
                            <option value="flatness">Flatness FF</option>
                        </select>
                        <label class="cb-label" title="Energy-based swing damping: adds force proportional to pendulum angular velocity to dissipate swing energy. Can be layered on any algorithm."><input type="checkbox" id="swing-b"> Anti-swing</label>
                    </div>
                    <div id="params-b" class="algo-params"></div>
                    <button id="reset-b" class="reset-params-btn">Reset to default</button>
                </div>
            </div>
            <div class="button-group">
                <button id="btn-pause">Pause</button>
                <button id="btn-pattern">Square</button>
                <button id="btn-reset">Reset</button>
            </div>
        </div>

        <div id="algo-info-panel" class="visible">
            <div id="info-panel-header"><span>Algorithm Info</span><button id="info-panel-toggle">&#x25BC;</button></div>
            <div id="info-panel-content">
                <p><a href="https://en.wikipedia.org/wiki/Linear%E2%80%93quadratic_regulator" target="_blank"><strong>LQR</strong></a> (Linear Quadratic Regulator) &mdash; Optimal full-state feedback controller that uses all 10 state variables: drone position &amp; velocity (x, y, z), pendulum swing angles (&phi;<sub>x</sub>, &phi;<sub>y</sub>) and their angular velocities (&phi;&#x307;<sub>x</sub>, &phi;&#x307;<sub>y</sub>). Computes gains by solving the <a href="https://en.wikipedia.org/wiki/Algebraic_Riccati_equation" target="_blank">continuous algebraic Riccati equation</a> (CARE), which finds the optimal trade-off between tracking performance and control effort. Tunable: <em>Pos weight</em> (how aggressively it tracks position), <em>Swing weight</em> (how strongly it suppresses pendulum oscillations), <em>Ctrl cost</em> (penalty on force usage &mdash; lower = more aggressive).</p>
                <p><a href="https://en.wikipedia.org/wiki/PID_controller" target="_blank"><strong>PID</strong></a> (Proportional-Integral-Derivative) &mdash; Classic 3-axis position controller that is completely blind to the pendulum dynamics &mdash; it only sees the drone&rsquo;s position error relative to the goal. Uses derivative-on-measurement (differentiates the drone position instead of the error signal) to avoid sudden force spikes when the goal changes. Tunable: <em>Kp</em> (proportional gain &mdash; immediate response to error), <em>Ki</em> (integral gain &mdash; eliminates steady-state offset over time), <em>Kd</em> (derivative gain &mdash; dampens oscillations by opposing velocity).</p>
                <p><a href="https://en.wikipedia.org/wiki/Cascade_control" target="_blank"><strong>Cascade PD</strong></a> (CPD) &mdash; Two nested <a href="https://en.wikipedia.org/wiki/PD_controller" target="_blank">PD control</a> loops inspired by overhead crane control. The outer loop measures the <em>payload</em> position error and computes a desired drone offset &mdash; if the payload is too far right, it commands the drone further right to &ldquo;pull&rdquo; it back. The inner loop then drives the drone to that desired position. Unlike plain PID, this explicitly tracks the payload rather than just the drone, which naturally reduces swing even without a pendulum model. Tunable: <em>Outer Kp/Kd</em> (payload tracking responsiveness) and <em>Inner Kp/Kd</em> (drone positioning aggressiveness).</p>
                <p><a href="https://en.wikipedia.org/wiki/Flatness_(systems_theory)" target="_blank"><strong>Flatness FF</strong></a> (Differential Flatness + Feedforward) &mdash; Exploits the mathematical property that the payload position is a <em>flat output</em> of the coupled drone-pendulum system. This means the exact drone trajectory and forces can be computed algebraically from any desired payload trajectory. The controller smooths the goal through a critically-damped 2nd-order reference filter, then inverts the linearized dynamics: desired drone position = payload position + (L/g) &times; payload acceleration, and desired pendulum angle &phi; = &minus;acceleration/g. Combines this feedforward with PD feedback on drone position and pendulum angle for robustness. Tunable: <em>Ref speed</em> (&omega; &mdash; reference filter bandwidth, higher = faster tracking), <em>Pos Kp</em> (position feedback strength), <em>Angle Kp</em> (pendulum angle correction strength).</p>
                <p><strong>Anti-Swing Damping</strong> (SD) &mdash; An energy-based damping layer that can be added on top of any controller. It adds a lateral force proportional to the pendulum&rsquo;s angular velocity: <code>F<sub>damp</sub> = k &middot; &phi;&#x307;</code>. This force &ldquo;chases&rdquo; the swing direction, which dissipates the pendulum&rsquo;s kinetic energy and damps oscillations. The gain k scales automatically with system mass and rope length. Particularly useful with PID and Cascade PD, which don&rsquo;t inherently account for swing dynamics.</p>
                <p><strong>State variables</strong> &mdash; The simulation tracks 10 state variables: drone position (x, y, z), drone velocity (x&#x307;, y&#x307;, z&#x307;), and two pendulum swing angles &phi;<sub>x</sub> and &phi;<sub>y</sub> with their angular velocities &phi;&#x307;<sub>x</sub> and &phi;&#x307;<sub>y</sub>. The angles &phi; describe how far the rope deviates from vertical in each lateral axis, measured in radians (displayed in degrees in the HUD). Physics are integrated using a 4th-order <a href="https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods" target="_blank">Runge-Kutta</a> (RK4) method at 50 Hz.</p>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module" src="main.js?v=2.0"></script>
</body>
</html>
