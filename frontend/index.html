<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone + Hanging Weight Simulation</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css?v=4.0">
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>

        <div id="hud">
            <div id="hud-header"><h3>Simulation HUD</h3><button id="hud-toggle">&#x25BC;</button></div>
            <div id="hud-content">
                <div id="hud-time">Time: 0.00 s</div>
                <div id="hud-drone">Drone: (0, 0, 0)</div>
                <div id="hud-weight">Weight: (0, 0, 0)</div>
                <div id="hud-angles">Angles: φx=0.00° φy=0.00°</div>
                <div id="hud-control">Control: Fx=0 Fy=0 Fz=0</div>
                <div id="hud-status">Status: Connecting...</div>
                <div id="hud-version" style="color:#666;font-size:11px">v4.0</div>
            </div>
        </div>

        <div id="chart-panel">
            <div id="chart-header"><span>Charts</span><button id="chart-toggle">&#x25BC;</button></div>
            <div id="chart-content"></div>
        </div>

        <div id="controls">
            <h3 class="collapsible" id="goal-header">Goal Position <span class="section-arrow">&#x25BC;</span></h3>
            <div id="goal-content" class="section-content">
                <div class="slider-group">
                    <label>X: <span id="x-val">0.0</span> m</label>
                    <input type="range" id="slider-x" min="-10" max="10" step="0.5" value="0">
                </div>
                <div class="slider-group">
                    <label>Y: <span id="y-val">0.0</span> m</label>
                    <input type="range" id="slider-y" min="-10" max="10" step="0.5" value="0">
                </div>
                <div class="slider-group">
                    <label>Z: <span id="z-val">1.0</span> m</label>
                    <input type="range" id="slider-z" min="0" max="15" step="0.5" value="1">
                </div>
                <div class="slider-group">
                    <label>Pattern spd: <span id="speed-val">1.0</span>x</label>
                    <input type="range" id="slider-speed" min="0.2" max="3.0" step="0.2" value="1.0">
                </div>
                <div class="slider-group">
                    <label>Goal smooth: <span id="smooth-val">3.0</span></label>
                    <input type="range" id="slider-smooth" min="0" max="8" step="0.5" value="3.0">
                </div>
            </div>
            <h3 class="collapsible" id="sim-header">Simulation <span class="section-arrow">&#x25B6;</span></h3>
            <div id="sim-content" class="section-content collapsed">
                <div class="slider-group">
                    <label>Drone mass: <span id="md-val">2.0</span> kg</label>
                    <input type="range" id="slider-md" min="0.5" max="10" step="0.5" value="2.0">
                </div>
                <div class="slider-group">
                    <label>Payload: <span id="mw-val">5.0</span> kg</label>
                    <input type="range" id="slider-mw" min="0.5" max="20" step="0.5" value="5.0">
                </div>
                <div class="slider-group">
                    <label>Rope: <span id="rope-val">4.0</span> m</label>
                    <input type="range" id="slider-rope" min="1" max="10" step="0.5" value="4.0">
                </div>
                <div class="slider-group">
                    <label>Max force: <span id="fmax-val">80</span> N</label>
                    <input type="range" id="slider-fmax" min="5" max="200" step="5" value="80">
                </div>
                <div class="slider-group">
                    <label>Time scale: <span id="timescale-val">100</span>%</label>
                    <input type="range" id="slider-timescale" min="5" max="100" step="5" value="100">
                </div>
            </div>
            <h3 class="collapsible" id="algo-header">Algorithm <span class="section-arrow">&#x25BC;</span></h3>
            <div id="algo-content" class="section-content">
                <div class="drone-config">
                    <div class="algo-row">
                        <label>Drone A <span style="color:#4499ff">(blue)</span></label>
                        <select id="algo-a">
                            <option value="off">Off</option>
                            <option value="lqr" selected>LQR</option>
                            <option value="pid">PID</option>
                            <option value="cascade">Cascade PD</option>
                            <option value="flatness">Flatness FF</option>
                            <option value="feedbacklin">Feedback Lin</option>
                            <option value="sliding">Sliding Mode</option>
                            <option value="mpc">MPC</option>
                        </select>
                        <label class="cb-label" title="Energy-based swing damping: adds force proportional to pendulum angular velocity to dissipate swing energy. Can be layered on any algorithm."><input type="checkbox" id="swing-a"> Anti-swing</label>
                        <label class="cb-label" title="ZVD Input Shaping: pre-filters the goal signal with 3 impulses timed at the pendulum natural frequency to eliminate residual swing."><input type="checkbox" id="shaping-a"> Input shaping</label>
                    </div>
                    <div id="params-a" class="algo-params"></div>
                    <button id="reset-a" class="reset-params-btn">Reset to default</button>
                    <button id="tune-a" class="tune-btn">Auto-tune</button>
                </div>
                <div class="drone-config">
                    <div class="algo-row">
                        <label>Drone B <span style="color:#ff8800">(orange)</span></label>
                        <select id="algo-b">
                            <option value="off">Off</option>
                            <option value="lqr">LQR</option>
                            <option value="pid" selected>PID</option>
                            <option value="cascade">Cascade PD</option>
                            <option value="flatness">Flatness FF</option>
                            <option value="feedbacklin">Feedback Lin</option>
                            <option value="sliding">Sliding Mode</option>
                            <option value="mpc">MPC</option>
                        </select>
                        <label class="cb-label" title="Energy-based swing damping: adds force proportional to pendulum angular velocity to dissipate swing energy. Can be layered on any algorithm."><input type="checkbox" id="swing-b"> Anti-swing</label>
                        <label class="cb-label" title="ZVD Input Shaping: pre-filters the goal signal with 3 impulses timed at the pendulum natural frequency to eliminate residual swing."><input type="checkbox" id="shaping-b"> Input shaping</label>
                    </div>
                    <div id="params-b" class="algo-params"></div>
                    <button id="reset-b" class="reset-params-btn">Reset to default</button>
                    <button id="tune-b" class="tune-btn">Auto-tune</button>
                </div>
                <button id="tune-all" class="tune-all-btn">Tune All Algorithms</button>
            </div>
            <div class="button-group">
                <button id="btn-pause">Pause</button>
                <select id="pattern-type">
                    <option value="square">Square</option>
                    <option value="mower">Mower</option>
                </select>
                <button id="btn-pattern">Start</button>
                <button id="btn-reset">Reset</button>
            </div>
        </div>

        <div id="tune-config" class="tune-modal hidden">
            <div class="tune-modal-content">
                <div class="tune-modal-header">
                    <span>Tuning Objective</span>
                    <button id="tune-config-close">&times;</button>
                </div>
                <div id="tune-config-body">
                    <div class="tune-config-row">
                        <label>Time preference (n): <span id="tc-n-val">1</span></label>
                        <div class="tune-config-desc">0 = all errors equal, 1 = standard ITAE, 2 = fast convergence at any cost</div>
                        <input type="range" id="tc-n" min="0" max="2" step="0.1" value="1">
                    </div>
                    <div class="tune-config-row">
                        <label>Tracking: <span id="tc-track-val">1</span></label>
                        <div class="tune-config-desc">Position error weight. Higher = reach target faster</div>
                        <input type="range" id="tc-track" min="0.1" max="5" step="0.1" value="1">
                    </div>
                    <div class="tune-config-row">
                        <label>Swing penalty: <span id="tc-swing-val">2</span></label>
                        <div class="tune-config-desc">Pendulum angle penalty. Higher = smoother payload</div>
                        <input type="range" id="tc-swing" min="0.1" max="20" step="0.1" value="2">
                    </div>
                    <div class="tune-config-row">
                        <label>Effort: <span id="tc-effort-val">0.001</span></label>
                        <div class="tune-config-desc">Control force penalty. Higher = gentler forces</div>
                        <input type="range" id="tc-effort" min="0" max="0.05" step="0.001" value="0.001">
                    </div>
                    <div class="tune-config-row">
                        <label>Settling: <span id="tc-settle-val">0.5</span></label>
                        <div class="tune-config-desc">Penalty for time outside 5% band</div>
                        <input type="range" id="tc-settle" min="0" max="5" step="0.1" value="0.5">
                    </div>
                </div>
                <div class="tune-config-footer">
                    <button id="tune-config-start">Start Tuning</button>
                </div>
            </div>
        </div>

        <div id="tune-modal" class="tune-modal hidden">
            <div class="tune-modal-content">
                <div class="tune-modal-header">
                    <span>Auto-Tune Results</span>
                    <button id="tune-modal-close">&times;</button>
                </div>
                <div id="tune-modal-body"></div>
            </div>
        </div>

        <div id="algo-info-panel" class="visible">
            <div id="info-panel-header"><span>Algorithm Info</span><button id="info-panel-toggle">&#x25BC;</button></div>
            <div id="info-panel-content">
                <p><a href="https://en.wikipedia.org/wiki/Linear%E2%80%93quadratic_regulator" target="_blank"><strong>LQR</strong></a> (Linear Quadratic Regulator) &mdash; Optimal full-state feedback controller that uses all 10 state variables: drone position &amp; velocity (x, y, z), pendulum swing angles (&phi;<sub>x</sub>, &phi;<sub>y</sub>) and their angular velocities (&phi;&#x307;<sub>x</sub>, &phi;&#x307;<sub>y</sub>). Computes gains by solving the <a href="https://en.wikipedia.org/wiki/Algebraic_Riccati_equation" target="_blank">continuous algebraic Riccati equation</a> (CARE), which finds the optimal trade-off between tracking performance and control effort. Tunable: <em>Pos weight</em> (how aggressively it tracks position), <em>Swing weight</em> (how strongly it suppresses pendulum oscillations), <em>Ctrl cost</em> (penalty on force usage &mdash; lower = more aggressive).</p>
                <p><a href="https://en.wikipedia.org/wiki/PID_controller" target="_blank"><strong>PID</strong></a> (Proportional-Integral-Derivative) &mdash; Classic 3-axis position controller that is completely blind to the pendulum dynamics &mdash; it only sees the drone&rsquo;s position error relative to the goal. Uses derivative-on-measurement (differentiates the drone position instead of the error signal) to avoid sudden force spikes when the goal changes. Tunable: <em>Kp</em> (proportional gain &mdash; immediate response to error), <em>Ki</em> (integral gain &mdash; eliminates steady-state offset over time), <em>Kd</em> (derivative gain &mdash; dampens oscillations by opposing velocity).</p>
                <p><a href="https://en.wikipedia.org/wiki/Cascade_control" target="_blank"><strong>Cascade PD</strong></a> (CPD) &mdash; Two nested <a href="https://en.wikipedia.org/wiki/PD_controller" target="_blank">PD control</a> loops inspired by overhead crane control. The outer loop measures the <em>payload</em> position error and computes a desired drone offset &mdash; if the payload is too far right, it commands the drone further right to &ldquo;pull&rdquo; it back. The inner loop then drives the drone to that desired position. Unlike plain PID, this explicitly tracks the payload rather than just the drone, which naturally reduces swing even without a pendulum model. Tunable: <em>Outer Kp/Kd</em> (payload tracking responsiveness) and <em>Inner Kp/Kd</em> (drone positioning aggressiveness).</p>
                <p><a href="https://en.wikipedia.org/wiki/Flatness_(systems_theory)" target="_blank"><strong>Flatness FF</strong></a> (Differential Flatness + Feedforward) &mdash; Exploits the mathematical property that the payload position is a <em>flat output</em> of the coupled drone-pendulum system. This means the exact drone trajectory and forces can be computed algebraically from any desired payload trajectory. Uses the global goal smoother&rsquo;s position, velocity, and acceleration reference to invert the linearized dynamics: desired drone position = payload position + (L/g) &times; payload acceleration, and desired pendulum angle &phi; = &minus;acceleration/g. Combines this feedforward with PD feedback on drone position and pendulum angle for robustness. Tunable: <em>Pos Kp</em> (position feedback strength), <em>Angle Kp</em> (pendulum angle correction strength).</p>
                <p><a href="https://en.wikipedia.org/wiki/Feedback_linearization" target="_blank"><strong>Feedback Lin</strong></a> (FBL &mdash; Feedback Linearization) &mdash; Applies a state-dependent nonlinear transformation that cancels the sin/cos coupling between the drone and pendulum, making the system behave like a simple double integrator. Once linearized, a PD controller drives position and angle to zero. The force law is: <code>F = (m<sub>d</sub> + m<sub>w</sub>sin&sup2;&phi;) &middot; v &minus; m<sub>w</sub>L sin&phi; &middot; &phi;&#x307;&sup2; &minus; m<sub>w</sub>g sin&phi; cos&phi;</code>, where <code>v</code> is the PD virtual input. Works well for moderate angles but demands large forces near singularities. Tunable: <em>Pos Kp</em> (position tracking), <em>Angle Ka</em> (pendulum angle suppression), <em>Rate Kb</em> (angular rate damping).</p>
                <p><a href="https://en.wikipedia.org/wiki/Sliding_mode_control" target="_blank"><strong>Sliding Mode</strong></a> (SMC) &mdash; Defines a sliding surface combining position error, velocity, pendulum angle, and angular rate: <code>s = &lambda;(x &minus; x<sub>des</sub>) + x&#x307; + &alpha;&phi; + &beta;&phi;&#x307;</code>. Computes an equivalent control to keep the state on the surface, plus a switching term <code>&minus;k&middot;sat(s/&epsilon;)</code> that forces trajectories toward it. Extremely robust to model uncertainty (wrong mass, rope length). A boundary layer &epsilon; smooths the switching to reduce force chattering. Tunable: <em>Convergence &lambda;</em> (surface slope), <em>Angle wt &alpha;</em> (pendulum influence), <em>Switch gain k</em> (correction strength), <em>Boundary &epsilon;</em> (chattering vs. precision trade-off).</p>
                <p><a href="https://en.wikipedia.org/wiki/Model_predictive_control" target="_blank"><strong>MPC</strong></a> (Model Predictive Control) &mdash; Solves a finite-horizon optimal control problem by running a backward <a href="https://en.wikipedia.org/wiki/Riccati_equation" target="_blank">discrete Riccati recursion</a> over N timesteps. At each step it minimizes a quadratic cost on position error, swing, and control effort, yielding a gain matrix applied to the current state error. Unlike infinite-horizon LQR, MPC&rsquo;s gains depend on the horizon length: short horizons (N=5) produce sluggish, conservative control; long horizons (N=200) converge to LQR-like performance. Gains are cached and only recomputed when sliders change. Tunable: <em>Horizon N</em> (planning depth), <em>Pos weight</em> (tracking aggressiveness), <em>Ctrl cost</em> (force penalty).</p>
                <p><strong>Input Shaping</strong> (IS &mdash; ZVD Shaper) &mdash; A pre-filter that reshapes the goal signal to eliminate residual pendulum swing. Uses the coupled pendulum frequency <code>&omega; = &radic;((m<sub>d</sub>+m<sub>w</sub>)g / (m<sub>d</sub>L))</code> to compute the natural period T, then convolves the reference with 3 ZVD impulses: <code>shaped(t) = 0.25&middot;goal(t) + 0.5&middot;goal(t&minus;T/2) + 0.25&middot;goal(t&minus;T)</code>. A pre-smoother converts step changes into smooth ramps before ZVD processing, ensuring smooth drone motion while maintaining swing cancellation. Can be layered on any controller via the checkbox. The trade-off is a delay of ~T seconds in the goal response. Automatically adapts when mass or rope length changes.</p>
                <p><strong>Anti-Swing Damping</strong> (SD) &mdash; An energy-based damping layer that can be added on top of any controller. It adds a lateral force proportional to the pendulum&rsquo;s angular velocity: <code>F<sub>damp</sub> = k &middot; &phi;&#x307;</code>. This force &ldquo;chases&rdquo; the swing direction, which dissipates the pendulum&rsquo;s kinetic energy and damps oscillations. The gain k scales automatically with system mass and rope length. Particularly useful with PID and Cascade PD, which don&rsquo;t inherently account for swing dynamics.</p>
                <p><strong>State variables</strong> &mdash; The simulation tracks 10 state variables: drone position (x, y, z), drone velocity (x&#x307;, y&#x307;, z&#x307;), and two pendulum swing angles &phi;<sub>x</sub> and &phi;<sub>y</sub> with their angular velocities &phi;&#x307;<sub>x</sub> and &phi;&#x307;<sub>y</sub>. The angles &phi; describe how far the rope deviates from vertical in each lateral axis, measured in radians (displayed in degrees in the HUD). Physics are integrated using a 4th-order <a href="https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods" target="_blank">Runge-Kutta</a> (RK4) method at 50 Hz.</p>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module" src="main.js?v=4.0"></script>
</body>
</html>
